<?xml version="1.0" standalone="no"?>

<kickstart>

<description>
        Extends Compute configuration
</description>


<changelog>
<![CDATA[
  $Id: extend-compute.xml,v 1.1 2016/04/11 02:07:37 root Exp root $
  $Date: 2016/04/11 02:07:37 $
]]>
</changelog>


<!-- There may be as many packages as needed here. Just make sure you only
     uncomment as many package lines as you need. Any empty <package></package>
     tags are going to confuse rocks and kill the installation procedure


<package>environment-modules</package>
-->

<package>compat-libstdc++-33.i686</package>
<package>libxml2.i686</package>
<package>binutils-devel</package>
<package>bash-completion</package>
<package>glibc-devel.i686</package>
<package>screen</package>
<package>lynx</package>

  
<post>
        <!-- Insert your post installation script here. This
        code will be executed on the destination node after the
        packages have been installed. Typically configuration files
        are built and services setup in this section. -->

<!-- Configure Modules -->
<file name="/etc/profile.d/modules.sh"  mode="append">
<![CDATA[
export -f module
]]>
</file>


<file name="/etc/rc.d/rocksconfig.d/post-03-411get" perms="0700">
<![CDATA[
#!/bin/bash

# Tell frontend to send you the 411 shared key
/opt/rocks/bin/get-411-key 10.1.1.1

# Wait 120 seconds for shared key to get populated
for i in {1..12}; do
        [ ! -f /etc/411-security/shared.key ] && sleep 10
done

# If shared key got transferred, do a 411get and pull information
# from frontend

[ -f /etc/411-security/shared.key ] && /opt/rocks/bin/411get --all

if [ -f /etc/rc3.d/S*autofs -o -f /etc/rc5.d/S*autofs ]; then
        /sbin/service autofs restart
fi

# Tell frontend to set your secure attributes
/opt/rocks/bin/rqst-sec-attrs 10.1.1.1

[ -f /etc/411-security/shared.key ] && rm -rf /etc/rc.d/rocksconfig.d/post-03-411get

]]>
</file>

<file name="/etc/sudoers.d/reboot" perms="0440" owner="root.root">
<![CDATA[
## Allows local users group to reboot this system
%users  ALL = NOPASSWD: /sbin/reboot
]]>
</file>

</post>

<post>
<!-- Add a host redirector for non IB nodes -->
<eval shell="bash" mode="xml">

if [[ &hostname; != "compute-2-"* ]] ; then
	echo "&lt;file name='/etc/hosts' mode='append' &gt;"
	echo  "&lt;![CDATA["
	echo  "# Infiniband not installed, override storage IP"
	echo  "10.1.1.1        FyrHead.ibnet"
	echo  "10.1.1.3        fyr-stor.ibnet"
	echo  "]]&gt;"
	echo "&lt;/file&gt;"
fi

</eval>

<file name='/etc/sysconfig/network-scripts/ifup-ib' perms='0755'>
<eval shell="sh">
/bin/cat /export/rocks/install/site-profiles/6.2/nodes/ifup-ib
</eval>
</file>

<file name='/etc/sysconfig/network-scripts/ifdown-ib' perms='0755'>
<eval shell="sh">
/bin/cat /export/rocks/install/site-profiles/6.2/nodes/ifdown-ib
</eval>
</file>

</post>

</kickstart>

