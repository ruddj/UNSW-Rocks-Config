<?xml version="1.0" standalone="no"?>

<kickstart>

<description>
        Extends Compute configuration
</description>


<changelog>
<![CDATA[
  $Id: extend-compute.xml 53 2010-08-10 09:00:38Z root $
  $Date: 2010-08-10 19:00:38 +1000 (Tue, 10 Aug 2010) $
]]>
</changelog>


<!-- There may be as many packages as needed here. Just make sure you only
     uncomment as many package lines as you need. Any empty <package></package>
     tags are going to confuse rocks and kill the installation procedure


<package>environment-modules</package>
-->

<!-- Updated Kernel for AMD Interlagos Support -->
<!--  <package>kernel-ml</package>
<package>kernel-ml-devel</package>
<package>kernel-ml-doc</package>
<package>kernel-ml-headers</package>
 -->

<!-- Mellanox Infiniband Drivers -->
<package>mlnxofed-docs</package>
<package>ofed-scripts</package>
<package>libibverbs</package>
<package>libibverbs-utils</package>
<package>libmlx4</package>
<package>libmlx5</package>
<package>libibverbs-devel</package>
<package>librdmacm</package>
<package>librdmacm-utils</package>
<package>librdmacm-devel</package>
<package>libibumad</package>
<package>libibmad</package>
<package>mstflint</package>
<package>mft</package>
<package>fca</package>
<package>knem</package>
<package>openshmem</package>
<package>opensm-libs</package>
<package>mxm</package>
<package>bupc</package>
<package>ibacm</package>
<package>compat-dapl</package>
<package>compat-dapl-devel</package>
<package>dapl</package>
<package>dapl-devel</package>
<package>dapl-devel-static</package>
<package>dapl-utils</package>
<package>infiniband-diags</package>
<package>infiniband-diags-compat</package>
<package>infinipath-psm</package>
<package>ibutils2</package>
<package>ibutils</package>
<package>cc_mgr</package>
<package>dump_pr</package>
<package>ar_mgr</package>
<package>ibdump</package>
<package>qperf</package>
<package>mstflint</package>
<package>perftest</package>
<package>libibprof</package>
<package>mlnx-ofa_kernel</package>
<package>mlnx-ofa_kernel-devel</package>
<package>kernel-ib-devel</package>
<package>kernel-ib</package>
<package>kernel-mft</package>
<package>rdma</package>

<post>
        <!-- Insert your post installation script here. This
        code will be executed on the destination node after the
        packages have been installed. Typically configuration files
        are built and services setup in this section. -->

<!-- Configure Modules -->
<file name="/etc/profile.d/modules.sh"  mode="append">
<![CDATA[
export -f module
]]>
</file>

<file name="/var/spool/torque/mom_priv/config" mode="append">
$pbsclient &Kickstart_PublicHostname;
$pbsclient &Kickstart_PrivateAddress;
$tmpdir    /state/partition1
</file>

<file name="/etc/rc.d/rocksconfig.d/post-03-411get" perms="0700">
<![CDATA[
#!/bin/bash

# Tell frontend to send you the 411 shared key
/opt/rocks/bin/get-411-key 10.1.1.1

# Wait 120 seconds for shared key to get populated
for i in {1..12}; do
        [ ! -f /etc/411-security/shared.key ] && sleep 10
done

# If shared key got transferred, do a 411get and pull information
# from frontend

[ -f /etc/411-security/shared.key ] && /opt/rocks/bin/411get --all

if [ -f /etc/rc3.d/S*autofs -o -f /etc/rc5.d/S*autofs ]; then
        /sbin/service autofs restart
fi

# Tell frontend to set your secure attributes
/opt/rocks/bin/rqst-sec-attrs 10.1.1.1

[ -f /etc/411-security/shared.key ] && rm -rf /etc/rc.d/rocksconfig.d/post-03-411get

]]>
</file>

<file name="/etc/sudoers.d/reboot" perms="0440" owner="root.root">
<![CDATA[
## Allows local users group to reboot this system
%users  ALL = NOPASSWD: /sbin/reboot
]]>
</file>

</post>

</kickstart>

