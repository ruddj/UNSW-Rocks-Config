<?xml version="1.0" standalone="no"?>

<kickstart>

<description>
        Extends Login configuration
</description>


<changelog>
<![CDATA[
  $Id: extend-login.xml,v 1.1 2016/04/11 02:07:37 root Exp root $
  $Date: 2016/04/11 02:07:37 $
]]>
</changelog>


<!-- There may be as many packages as needed here. Just make sure you only
     uncomment as many package lines as you need. Any empty <package></package>
     tags are going to confuse rocks and kill the installation procedure


<package>environment-modules</package>
-->

<!-- Updated Kernel for AMD Interlagos Support -->
<!--  <package>kernel-ml</package>
<package>vim</package>
<package>vim-enhanced</package>
<package>vim-common</package>
 -->

<package>vim</package>
<package>vim-enhanced</package>
<package>vim-common</package>
<package>cmake</package>
<package>flex</package>
<package>qt-devel</package>
<package>binutils-devel</package>
<package>screen</package>
<package>lynx</package>
<package>bash-completion</package>
<package>glibc-devel.i686</package>
<package>compat-libstdc++-33.i686</package>
<package>libxml2.i686</package>

<!-- Fail 2 Ban to lockdown Login Nodes -->
<package>fail2ban</package>

<post>
        <!-- Insert your post installation script here. This
        code will be executed on the destination node after the
        packages have been installed. Typically configuration files
        are built and services setup in this section. -->

<!-- Configure Modules -->
<file name="/etc/profile.d/modules.sh"  mode="append">
<![CDATA[
export -f module
]]>
</file>


<file name="/etc/rc.d/rocksconfig.d/post-03-411get" perms="0700">
<![CDATA[
#!/bin/bash

# Tell frontend to send you the 411 shared key
/opt/rocks/bin/get-411-key 10.1.1.1

# Wait 120 seconds for shared key to get populated
for i in {1..12}; do
        [ ! -f /etc/411-security/shared.key ] && sleep 10
done

# If shared key got transferred, do a 411get and pull information
# from frontend

[ -f /etc/411-security/shared.key ] && /opt/rocks/bin/411get --all

if [ -f /etc/rc3.d/S*autofs -o -f /etc/rc5.d/S*autofs ]; then
        /sbin/service autofs restart
fi

# Tell frontend to set your secure attributes
/opt/rocks/bin/rqst-sec-attrs 10.1.1.1

[ -f /etc/411-security/shared.key ] && rm -rf /etc/rc.d/rocksconfig.d/post-03-411get

]]>
</file>

<file name="/etc/ssh/sshd_config" mode="append">
<![CDATA[
Port 22
Port 2052
PermitRootLogin without-password
]]>
</file>


<file name="/etc/fail2ban/jail.local" mode="append">
<![CDATA[
[DEFAULT]
ignoreip =  127.0.0.1 10.1.0.0/16

[sshd]
enabled  = true
maxretry = 5
banaction = iptables-allports

[sshd-ddos]
# This jail corresponds to the standard configuration in Fail2ban.
# The mail-whois action send a notification e-mail with a whois request
# in the body.
enabled  = true
banaction = iptables-allports

]]>
</file>

<file name="/etc/hosts"  mode="append">
<![CDATA[
# Infiniband not installed, override storage IP
10.1.1.1        FyrHead.ibnet
10.1.1.3        fyr-stor.ibnet

]]>
</file>

</post>

</kickstart>

