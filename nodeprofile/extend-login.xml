<?xml version="1.0" standalone="no"?>

<kickstart>

<description>
        Extends Login configuration
</description>


<changelog>
<![CDATA[
  $Id: extend-compute.xml 53 2010-08-10 09:00:38Z root $
  $Date: 2010-08-10 19:00:38 +1000 (Tue, 10 Aug 2010) $
]]>
</changelog>


<!-- There may be as many packages as needed here. Just make sure you only
     uncomment as many package lines as you need. Any empty <package></package>
     tags are going to confuse rocks and kill the installation procedure


<package>environment-modules</package>
-->

<!-- Updated Kernel for AMD Interlagos Support -->
<!--  <package>kernel-ml</package>
<package>vim</package>
<package>vim-enhanced</package>
<package>vim-common</package>
 -->

<package>vim</package>
<package>vim-enhanced</package>
<package>vim-common</package>
<package>cmake</package>
<package>flex</package>


<!-- Fail 2 Ban to lockdown Login Nodes -->
<package>fail2ban</package>

<post>
        <!-- Insert your post installation script here. This
        code will be executed on the destination node after the
        packages have been installed. Typically configuration files
        are built and services setup in this section. -->

<!-- Configure Modules -->
<file name="/etc/profile.d/modules.sh"  mode="append">
<![CDATA[
export -f module
]]>
</file>

<file name="/opt/torque/mom_priv/config" mode="append">
<![CDATA[
$pbsclient FyrHead.ad.unsw.edu.au
$pbsclient 10.1.1.1
$tmpdir    /state/partition1
]]>
</file>

<file name="/etc/rc.d/rocksconfig.d/post-03-411get" perms="0700">
<![CDATA[
#!/bin/bash

# Tell frontend to send you the 411 shared key
/opt/rocks/bin/get-411-key 10.1.1.1

# Wait 120 seconds for shared key to get populated
for i in {1..12}; do
        [ ! -f /etc/411-security/shared.key ] && sleep 10
done

# If shared key got transferred, do a 411get and pull information
# from frontend

[ -f /etc/411-security/shared.key ] && /opt/rocks/bin/411get --all

if [ -f /etc/rc3.d/S*autofs -o -f /etc/rc5.d/S*autofs ]; then
        /sbin/service autofs restart
fi

# Tell frontend to set your secure attributes
/opt/rocks/bin/rqst-sec-attrs 10.1.1.1

[ -f /etc/411-security/shared.key ] && rm -rf /etc/rc.d/rocksconfig.d/post-03-411get

]]>
</file>

<file name="/etc/ssh/sshd_config" mode="append">
<![CDATA[
Port 22
Port 2052
PermitRootLogin without-password
]]>
</file>


<file name="/etc/fail2ban/jail.local" mode="append">
<![CDATA[
[DEFAULT]
ignoreip = 127.0.0.1 10.1.1.1
bantime  = 600
findtime  = 600
maxretry = 5
backend = auto

[ssh-iptables]
enabled  = true
filter   = sshd
action   = iptables-allports[name=SSH, protocol=all]
logpath  = /var/log/secure
maxretry = 5

]]>
</file>


</post>

</kickstart>

